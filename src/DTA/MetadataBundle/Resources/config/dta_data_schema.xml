<?xml version="1.0" encoding="utf-8"?>

<!-- 
    Contains all entities related to historical facts.
-->

<!--The name attribute refers to the connection to use. See app/config/config.yml under
    propel > dbal > connections for connection setup. -->
<database name="dtametadata" namespace="DTA\MetadataBundle\Model\Data" defaultIdMethod="native">
  
    <!-- This parameter set is added to each entity that doesn't implement the table_row_view behavior. 
    It is not added to tables/entities that define the bahavior. -->
    <behavior name="table_row_view">
        <!--If no parameters are defined, all columns are added. (WITHOUT embedding any related entities) -->
    </behavior>
    
    <!-- The base class for all publications. -->
    <table name="publication">
        
        <!-- TODO: enable autoincrement. During conversion, the ids are set as the ids of the legacy database.-->
        <column name="id" type="INTEGER" primaryKey="true" autoIncrement="false" required="true"/>
        
        <column name="title_id" type="INTEGER" required="true"/>
        
        <!--Personalia werden ueber Fremdschluessel von der Personenseite dargestellt.-->
        
        <column name="firsteditionpublication_id" description="Publikation, die die Informationen zur Erstauflage enthält" type="INTEGER"/>
        
        <column name="place_id" description="Druckort" type="INTEGER"/>
        <column name="publicationdate_id" description="Erscheinungsjahr" type="INTEGER"/>
        <column name="creationdate_id" description="Erscheinungsjahr der Erstausgabe" type="INTEGER"/>
        <column name="publishingcompany_id" description="Verlag" type="INTEGER"/>
        <column name="source_id" description="Zur Sicherheit aus der alten DB übernommen" type="INTEGER"/>
        
        <!-- Bild- und Textquellen über die imageSource Tabelle dargestellt, da publication:imageSource eine 1:n Beziehung ist -->

        <column name="partner_id" description="akquiriert über" type="INTEGER"/>

        <!--Editorisches-->        
        <column name="editiondescription" description="Art der Ausgabe" type="LONGVARCHAR"/>
        <column name="digitaleditioneditor" description="Bearbeiter der digitalen Edition" type="LONGVARCHAR"/>
        <column name="transcriptioncomment" description="Bemerkungen zu den Transkriptionsrichtlinien" type="LONGVARCHAR"/>
        
        <!--Klassifikation und Einordnung-->
        <!--vorherrschende Sprache, Kategorien, Schlagworte und Genres sind durch das Werk festgelegt.-->
    
        <column name="numpages" description="Anzahl Seiten (Umfang)" type="LONGVARCHAR"/>
        <column name="numpagesnumeric" description="Umfang (normiert)" type="INTEGER"/>
    
        <column name="comment" description="Anmerkungen" type="LONGVARCHAR"/>
        <column name="encoding_comment" description="Kommentar Encoding" type="LONGVARCHAR"/>
        
        <column name="doi" type="LONGVARCHAR"/>
        <column name="format" type="LONGVARCHAR"/>
        <column name="directoryname" type="LONGVARCHAR"/>
        <column name="wwwready" type="INTEGER"/>
        
        <column name="last_changed_by_user_id" type="INTEGER"/>
        
        <!--Workflow-Aspekte -->        
        <!--<column name="status_id" type="INTEGER" required="true"/>-->

        <behavior name="table_row_view">
            <!--<parameter name="Datenbank ID" value="id"/>-->
            <parameter name="Titel" value="accessor:getTitle"/>
            <parameter name="erster Autor" value="accessor:getFirstAuthor"/>
            <!--<parameter name="entstanden" value="accessor:getDatespecificationRelatedByCreationdateId"/>-->
            <parameter name="Verlag" value="accessor:getPublishingCompany"/>
            <parameter name="veröffentlicht" value="accessor:getDatespecificationRelatedByPublicationdateId"/>
            <!--<parameter name="embedcolumnsstatus" value="status"/>-->
            <parameter name="embedcolumnstitle" value="title"/>
            <parameter name="query" value="\DTA\MetadataBundle\Model\Data\PublicationQuery::create()
                    ->leftJoinWith('Title')
                    ->leftJoinWith('Title.Titlefragment')
                    ->leftJoinWith('DatespecificationRelatedByPublicationdateId')
                    ->leftJoinWith('PersonPublication')
                    ->leftJoinWith('PersonPublication.Person')
                    ->leftJoinWith('Person.Personalname')
                    ->leftJoinWith('Personalname.Namefragment');" />
        </behavior>
        
        <behavior name="timestampable"/>
        <behavior name="reconstructed_flaggable">
            <parameter name="column" value="publishingcompany_id"/>
        </behavior>
        
        <foreign-key foreignTable="title"> <reference local="title_id" foreign="id"/> </foreign-key>
        <foreign-key foreignTable="source"> <reference local="source_id" foreign="id"/> </foreign-key>
        <foreign-key foreignTable="publishingcompany"> <reference local="publishingcompany_id" foreign="id"/> </foreign-key>
        <foreign-key foreignTable="place"> <reference local="place_id" foreign="id"/> </foreign-key>
        <foreign-key foreignTable="datespecification"> <reference local="publicationdate_id" foreign="id"/> </foreign-key>
        <foreign-key foreignTable="datespecification"> <reference local="creationdate_id" foreign="id"/> </foreign-key>
        <foreign-key foreignTable="dta_user" phpName="LastChangedByUser" refPhpName="LastChangedPublication"> <reference local="last_changed_by_user_id" foreign="id"/> </foreign-key>
    </table>

        
    <!-- Publication types. -->

    <!--                          -->
    <!--M: Einteilige Monographie.-->
    <!--                          -->
    <table name="publication_m">
        <column name="id" type="INTEGER" primaryKey="true" autoIncrement="true" required="true"/>
        <column name="publication_id" type="INTEGER" required="true"/>
        
        <behavior name="table_row_view"> <parameter name="embedColumnspublication" value="publication"/> </behavior>
        <foreign-key foreignTable="publication"> <reference local="publication_id" foreign="id"/> </foreign-key>
    </table>
    
    <!--                          -->
    <!--DM: Unselbstständiger Teil einer Monographie, z.B. Beitrag in Sammelband oder ein Buchkapitel.-->
    <!--                          -->
    <table name="publication_dm">
        <column name="id" type="INTEGER" primaryKey="true" autoIncrement="true" required="true"/>
        <column name="publication_id" type="INTEGER" required="true"/>
        
        <column name="title_id" description="Titel des übergeordneten Werkes" type="INTEGER" required="true"/>
        <column name="pages" description="Seitenangabe" type="LONGVARCHAR"/>
        
        <behavior name="table_row_view"> <parameter name="embedcolumnspublication" value="publication"/> </behavior>
        
        <foreign-key foreignTable="publication"> <reference local="publication_id" foreign="id"/> </foreign-key>
    </table>   
    
    <!--DS: Unselbständige Schrift in einem Band, der Teil einer Reihe ist.-->
    <table name="publication_ds">
        <column name="id" type="INTEGER" primaryKey="true" autoIncrement="true" required="true"/>
        <column name="publication_id" type="INTEGER" required="true"/>
        
        <column name="series_id" type="INTEGER" required="true"/>
        <!--<column name="volume_id" type="INTEGER" required="true"/>-->
        <column name="pages" description="Seitenangabe" type="LONGVARCHAR"/>
        
        <behavior name="table_row_view"> <parameter name="embedcolumnspublication" value="publication"/> </behavior>
        
        <foreign-key foreignTable="publication"> <reference local="publication_id" foreign="id"/> </foreign-key>
        <!--<foreign-key foreignTable="volume"> <reference local="volume_id" foreign="id"/> </foreign-key>-->
        <foreign-key foreignTable="series"> <reference local="series_id" foreign="id"/> </foreign-key>
    </table> 
    
    <!--MS: Selbstständiger Band einer Reihe.-->
    <table name="publication_ms">
        <column name="id" type="INTEGER" primaryKey="true" autoIncrement="true" required="true"/>
        <column name="publication_id" type="INTEGER" required="true"/>
        
        <column name="series_id" type="INTEGER" required="true"/>
        <column name="volumenumberinseries" description="Nummer des Bandes innerhalb der Reihe" type="LONGVARCHAR"/>
        
        <behavior name="table_row_view"> <parameter name="embedcolumnspublication" value="publication"/> </behavior>
        
        <foreign-key foreignTable="publication"> <reference local="publication_id" foreign="id"/> </foreign-key>
        <foreign-key foreignTable="series"> <reference local="series_id" foreign="id"/> </foreign-key>
    </table> 
    
    <!--JA: Artikel einer Zeitschrift/Zeitung.-->
    <table name="publication_ja">
        <column name="id" type="INTEGER" primaryKey="true" autoIncrement="true" required="true"/>
        <column name="publication_id" type="INTEGER" required="true"/>
        
        <!--<column name="volume_id" description="Teil (bei einer mehrteiligen Publikation)" type="INTEGER" required="true"/>-->
        <column name="parent" description="Zeitschrift, in der erschienen" type="INTEGER" required="true"/>
        
        <behavior name="table_row_view"> <parameter name="embedcolumnspublication" value="publication"/> </behavior>
        
        <foreign-key foreignTable="publication"> <reference local="publication_id" foreign="id"/> </foreign-key>
        <!--<foreign-key foreignTable="volume"> <reference local="volume_id" foreign="id"/> </foreign-key>-->
    </table> 
    
    <!--MMS: Teil einer mehrbändigen Monographie, die ihrerseits Teil einer Reihe ist.-->
    <table name="publication_mms">
        <column name="id" type="INTEGER" primaryKey="true" autoIncrement="true" required="true"/>
        <column name="publication_id" type="INTEGER" required="true"/>
        
        <column name="series_id" type="INTEGER" required="true"/>
        <!--<column name="volume_id" type="INTEGER" required="true"/>-->
        
        <behavior name="table_row_view"> <parameter name="embedcolumnspublication" value="publication"/> </behavior>
        
        <foreign-key foreignTable="publication"> <reference local="publication_id" foreign="id"/> </foreign-key>
        <!--<foreign-key foreignTable="volume"> <reference local="volume_id" foreign="id"/> </foreign-key>-->
        <foreign-key foreignTable="series"> <reference local="series_id" foreign="id"/> </foreign-key>
    </table> 
    
    <!--J: Zeitschriften-/Zeitungsausgabe.-->
    <table name="publication_j">
        <column name="id" type="INTEGER" primaryKey="true" autoIncrement="true" required="true"/>
        <column name="publication_id" type="INTEGER" required="true"/>
        
        <column name="edition" description="Ausgabe" type="LONGVARCHAR"/>
        
        <behavior name="table_row_view"> <parameter name="embedcolumnspublication" value="publication"/> </behavior>
        
        <foreign-key foreignTable="publication"> <reference local="publication_id" foreign="id"/> </foreign-key>
    </table> 
    
    <!--Ein Band einer mehrbaendigen etwas.-->
    <table name="volume">
        <column name="id" type="INTEGER" primaryKey="true" autoIncrement="true" required="true"/>
        <!--Inheritance-->
        <column name="publication_id" type="INTEGER" required="true"/>
        
        <!--Parent publication-->
        <column name="parentpublication_id" type="INTEGER" required="true"/>
        
        <column name="volumedescription" description="Bezeichnung des Bandes (alphanumerisch)" type="INTEGER"/>
        <column name="volumenumeric" description="Bezeichnung des Bandes (numerisch)" type="INTEGER"/>
        <column name="volumestotal" description="Anzahl Bände (gesamt)" type="INTEGER"/>
        
        <foreign-key foreignTable="publication"> <reference local="publication_id" foreign="id"/> </foreign-key>
        <foreign-key foreignTable="publication"> <reference local="parentpublication_id" foreign="id"/> </foreign-key>
        
        <behavior name="table_row_view"> <parameter name="embedcolumnspublication" value="publication"/> </behavior>
    </table>
    
    <!--Eine Reihe.-->
    <table name="series">
        <column name="id" type="INTEGER" primaryKey="true" autoIncrement="true" required="true"/>
        <column name="title_id" type="INTEGER" required="true"/>
        
        <foreign-key foreignTable="title"> <reference local="title_id" foreign="id"/> </foreign-key>
    </table>
    
    <!-- Other entities that can be considered historical facts. -->


    <table name="publishingcompany">
        <column name="id" type="INTEGER" primaryKey="true" autoIncrement="true" required="true"/>
        <column name="name" type="LONGVARCHAR" required="true"/>
        <column name="gnd" type="VARCHAR" size="255"/> 
        <behavior name="table_row_view"> <parameter name="Name" value="name"/><parameter name="GND" value="gnd"/> </behavior>
        <unique> <unique-column name="gnd"/> </unique>
        <validator column="gnd"> <rule name="unique" message="GND ist schon vergeben!"/> </validator>
    </table>

    <table name="place">
        <column name="id" type="INTEGER" primaryKey="true" autoIncrement="true" required="true"/>
        <column name="name" type="LONGVARCHAR" required="true"/>
        <column name="gnd" type="VARCHAR" size="255"/> 
        <unique> <unique-column name="gnd"/> </unique>
        <validator column="gnd"> <rule name="unique" message="GND ist schon vergeben!"/> </validator>
    </table>

    <table name="datespecification">
        <column name="id" type="INTEGER" primaryKey="true" autoIncrement="true" required="true"/>
        <column name="year" type="INTEGER"/>
        <column name="comments" type="LONGVARCHAR"/>
        
        <behavior name="reconstructed_flaggable">
            <parameter name="column" value="year"/>
        </behavior>
    </table>
    
    <!-- Personenname, besteht aus mehreren Namensfragmenten (nameFragment). -->
    <table name="personalname">
        <column name="id" type="INTEGER" primaryKey="true" autoIncrement="true" required="true"/>
        <column name="person_id" type="INTEGER" required="true"/>
        <behavior name="sortable">
            <parameter name="scope_column" value="id"/>
        </behavior>
        <behavior name="table_row_view">
            <parameter name="name" value="accessor:__toString"/>
            <parameter name="zugeordnet (personen-id)" value="person_id"/>
            <parameter name="reihenfolge" value="accessor:getSortableRank"/>
        </behavior>
        <foreign-key foreignTable="person" onDelete="cascade"> <reference local="person_id" foreign="id"/> </foreign-key>
    </table>
    
    <!-- Namensfragmente sind Bestandteile eines Namens, z.B. Vor- oder Nachname. -->
    <table name="namefragment">
        <column name="id" type="INTEGER" primaryKey="true" autoIncrement="true" required="true"/>
        <column name="personalname_id" type="INTEGER" required="true"/>
        <column name="name" type="LONGVARCHAR" required="true"/>
        <column name="namefragmenttypeid" type="INTEGER" required="true"/>

        <foreign-key foreignTable="namefragmenttype"> 
            <reference local="namefragmenttypeid" foreign="id"/> 
        </foreign-key>
        <foreign-key foreignTable="personalname" onDelete="cascade"> <reference local="personalname_id" foreign="id"/> </foreign-key>
        
        <behavior name="sortable">
            <parameter name="use_scope" value="true"/>
            <parameter name="scope_column" value="personalname_id"/>
        </behavior>
        <behavior name="table_row_view">
            <parameter name="bestandteil" value="name"/>
            <parameter name="embedcolumnsart" value="namefragmenttype"/>
        </behavior>
    </table>
    
    <table name="title">
        <column name="id" type="INTEGER" primaryKey="true" autoIncrement="true" required="true"/>
        <behavior name="table_row_view">
            <!--<parameter name="id" value="id"/>-->
            <parameter name="titel" value="accessor:__toString"/>
        </behavior>
    </table>
    
    <table name="titlefragment">
        
        <column name="id" type="INTEGER" primaryKey="true" autoIncrement="true" required="true"/>
        <column name="name" type="LONGVARCHAR" required="true"/>
        <column name="title_id" type="INTEGER" required="true"/>
        <column name="titlefragmenttype_id" type="INTEGER" required="true"/>
        <foreign-key foreignTable="title" onDelete="cascade"> <reference local="title_id" foreign="id"/> </foreign-key>
        <foreign-key foreignTable="titlefragmenttype"> <reference local="titlefragmenttype_id" foreign="id"/> </foreign-key>
        
        <behavior name="sortable">
            <parameter name="use_scope" value="true"/>
            <parameter name="scope_column" value="title_id"/>
        </behavior>
        <behavior name="reconstructed_flaggable">
            <parameter name="column" value="name"/>
        </behavior>
        
    </table>
    
    <table name="person">
        <column name="id" type="INTEGER" primaryKey="true" autoIncrement="true" required="true"/>
        <!--255 is the maximum length for a limit of 1000 bytes. required to allow unique indexing-->
        <column name="gnd" type="VARCHAR" size="255"/> 
        <!--The name is added in the personalName table because it's a one-to-many relationship.-->
        
        <behavior name="table_row_view">
            <parameter name="erster name@representative" value="personalname"/>
            <!--<parameter name="namen gesamt@count" value="personalname"/>-->
            <parameter name="gnd" value="gnd"/>
            <parameter name="query" value="DTA\MetadataBundle\Model\Data\PersonQuery::create()->joinWith('Personalname')->joinWith('Personalname.Namefragment')->joinWith('Namefragment.Namefragmenttype')->orderBy('Namefragmenttype.id', \Criteria::DESC)->orderBy('Namefragment.name');"/>
        </behavior>
        
        <unique> <unique-column name="gnd"/> </unique>
    </table>
    
    <table name="font">
        <column name="id" type="INTEGER" primaryKey="true" autoIncrement="true" required="true"/>
        <column name="name" type="LONGVARCHAR" required="true"/>
        <behavior name="table_row_view">
            <parameter name="Name" value="name"/>
        </behavior>
    </table>
    
    <table name="language">
        <column name="id" type="INTEGER" primaryKey="true" autoIncrement="true" required="true"/>
        <column name="name" type="LONGVARCHAR" required="true"/>
        <behavior name="table_row_view">
            <parameter name="Name" value="name"/>
        </behavior>
    </table>
    
</database>
